---
title: "DisCon Kids Pilot Summary"
output: html_document
---

```{r setup, include=FALSE}
#Libraries
knitr::opts_chunk$set(echo = FALSE, warning = FALSE) #no code, no warning printed
library(knitr)
library(tidyverse)
library(ggplot2)
library(jsonlite)
library(tidyr)
library(stringr)
library(dplyr)
library(ggthemes)
library(langcog)
```

```{r data loading, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE) 

#Data preprocessing
files <- dir("../../kids_simple/")

raw_data <- data_frame()
for (f in files) {
  jf <- paste("../../kids_simple/",f,sep="")
  jd <- fromJSON(paste(readLines(jf), collapse=""))
  id <- as_data_frame(jd$data$data)
  raw_data <- bind_rows(raw_data, id)
}

data <- raw_data %>%
  mutate(distribution = as.character(distribution),
         distribution = factor(distribution, levels = c("c(6, 0, 0)", "c(4, 2, 0)", "c(2, 2, 2)")),
         subage = ifelse(subid == '180831_5', 2, subage)) # child 180831_5 is 2 but recorded as 3

write.csv(data, file="../data/01_kids_summary.data.csv")

data <- read_csv(file="../data/pilot.data.csv")
```

```{r sanity checks, include=FALSE} 
#remove participants who do not pass the training threshold
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)

data <- data %>% 
  filter(subid != "", subid != "test", subid != "Test")

data %>%
  filter(phase == 'training') %>%
  group_by(subid) %>%
  summarise(correct = mean(correct_item))

drop <- data %>%
  filter(phase == 'training') %>%
  group_by(subid) %>%
  summarise(correct = mean(correct_item)) %>%
  filter(correct < 0.83) %>%
  pull(subid)

data <- data %>%
  filter(!subid %in% drop)
```

# Kids' Experiment

## Task description 

Each experiment contains 4 trials, because a previous pilot run with 4 children showed that 6 trials is too long for their attention span. Each trial contains 6 training slides (non-ambiguous utterance) and 1 test slide (ambiguous utterance), as shown below. Instead of showing the words on the screen like in the adult pilot, sound recordings of the animals are played.

![Training slide](../pictures/kids_training.png){width=350px} ![Test slide](../pictures/kids_test.png){width=350px}

Left: training slide, Right: test slide

The items appearing in a trial belong to a set of 3 categories of items (from the 6 categories: musical instruments, fruits, vehicles, furniture, mammals, clothes) that is unique across 4 trials. We run the experiment with distribution (6-0-0) across all 4 trials, with each number corresponding to how many times a category has items appear in the trial. This is to see if children are able to make category inference from the most informative set of input.

In contrast to the adult version, we moved the items first because during the first pilot run, children had a strong bias to pick the item in the middle, presumably because they were trying to interpret the agent's gaze.

## Sample size
We remove responses that get less than 5/6 correct in training slides.

```{r sample size, echo=FALSE}
sample_size <- data %>%
  distinct(subid, .keep_all = TRUE)

sample_size %>%
 group_by(subage) %>%
 summarise(n = n()) %>%
 kable(col.names = c(`subage` = "age", `n` = "n"))
```

## Finding

### Overall
```{r plot1 jitter, echo=FALSE, warning = FALSE}
#Jitter version
plot1 <- data %>%
  filter(phase == 'test') %>%
  group_by(distribution, subid) %>%
  summarise(correct = mean(correct_target1),
            correct2 = mean(correct_target2),
            correct3 = mean(correct_target3)) %>%
  gather(item, prop_correct, -distribution, -subid) %>%
  group_by(distribution, item)

plot1a <- plot1 %>%
  multi_boot_standard(col = "prop_correct")

ggplot() +
  geom_jitter(data = plot1, aes(x = item, y = prop_correct, col = item, alpha = .2), width = .3,height = .025)+
  geom_pointrange(data = plot1a, aes(x = item, y = mean, col = item, ymin = ci_lower, ymax = ci_upper),size = .8)+
  scale_colour_solarized(name = "Chosen item", 
                         breaks = c("correct", "correct2", "correct3"),
                         labels = c("most frequent", "second most frequent", "least frequent")) +
  facet_grid(~distribution, 
             labeller = as_labeller(c(`c(6, 0, 0)` = "Distribution\n(6-0-0)", `c(4, 2, 0)` = "Distribution\n(4-2-0)", `c(2, 2, 2)` = "Distribution\n(2-2-2)", preference = "preference", statistical = "statistical"))) +
  geom_hline(yintercept = 1/3, lty=2)+
  labs(x="", y="proportion chosen")+
  theme_few() +
  ylim(-0.05,1.05)+
  guides(alpha = F) +
  theme(axis.text.x=element_blank(),axis.ticks.x=element_blank()) 
```

The dotted line represents performance expected by chance (1/3), and the error bar are 95% CIs.

More participants are able to choose the item from the most frequent category compared to the other two categories, however, performance is not much above chance level. 

### By age group

We then want to further look at the result by age group.

```{r plot2, fig.width = 8, echo=FALSE, warning = FALSE}
plot2 <- data %>%
  filter(phase == 'test') %>%
  group_by(distribution, subid, subage) %>%
  summarise(correct = mean(correct_target1),
            correct2 = mean(correct_target2),
            correct3 = mean(correct_target3)) %>%
  gather(item, prop_correct, -distribution, -subid, -subage) %>%
  group_by(distribution, item, subage) %>%
  multi_boot_standard(col = "prop_correct")

ggplot(plot2,
       aes(x = item, y=mean, fill=item)) +
  geom_bar(stat='identity') +
  geom_linerange(aes(ymin = ci_lower, ymax = ci_upper)) +
  scale_fill_solarized(name = "Chosen item",
                       breaks = c("correct", "correct2", "correct3"),
                       labels = c("most frequent", "second most frequent", "least frequent"))+
  facet_grid(distribution~subage, 
             labeller = as_labeller(c(`c(6, 0, 0)` = "Distribution\n(6-0-0)", `c(4, 2, 0)` = "Distribution\n(4-2-0)", `c(2, 2, 2)` = "Distribution\n(2-2-2)", `2` = "2", `3` = "3", `4` = "4"))) +
  geom_hline(yintercept = 1/3, lty=2) +
  ylim(0, 1) +
  theme_few() +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  labs(x="", y= "proportion chosen")
```

From the data, 2-year-olds appear to be best at choosing the item from the most frequent category, followed by 3 and 4-year-olds respectively. However, this may be because of the small number of participants for each age group, and also the distribution of most frequent categories. 

### Choosing the middle item

When only cases where the participants did not choose the correct item are included, we observe a higher proportion of participants choosing the middle item than the left and right items.

```{r plot4, echo=FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)

plot4 <- data %>%
  filter(phase == 'test', correct_target1 == 0) %>%
  mutate(pick_l = ifelse(pickPos == "item_l", 1, 0), 
         pick_m = ifelse(pickPos == "item_m", 1, 0),
         pick_r = ifelse(pickPos == "item_r", 1, 0)) %>%
  group_by(distribution, subid) %>%
  summarise(choose_l = mean(pick_l),
            choose_m = mean(pick_m),
            choose_r = mean(pick_r)) %>%
  gather(item, prop_choose, -distribution, -subid) %>%
  group_by(distribution, item) %>%
  multi_boot_standard(col = "prop_choose")
  
ggplot(plot4,
       aes(x = item, y=mean, fill=item)) +
  geom_bar(stat='identity') +
  geom_linerange(aes(ymin = ci_lower, ymax = ci_upper)) +
  scale_fill_solarized(name = "Chosen item",
                       breaks = c("choose_l", "choose_m", "choose_r"),
                       labels = c("left", "middle", "right"))+
  facet_grid(~distribution, 
             labeller = as_labeller(c(`c(6, 0, 0)` = "Distribution\n(6-0-0)", `c(4, 2, 0)` = "Distribution\n(4-2-0)", `c(2, 2, 2)` = "Distribution\n(2-2-2)"))) +
  geom_hline(yintercept = 1/3, lty=2) +
  ylim(0, 1) +
  theme_few() +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  labs(x="", y= "proportion chosen")
```

### Result by category

During the pilot, it also seemed that participants are able to pick up on some categories more than others. 

For reference, the number of appearances as the most frequent category for each category is as such: 

```{r category size, echo=FALSE}
category_size <- data %>%
  filter(phase == "test") %>%
  group_by(target1) %>%
  summarise(n = n()) %>%
  kable(col.names = c(`target1` = "category", `n` = "n"))

category_size
```

Here we're plotting only the most frequent category. Participants picked up on mammals the most, followed by vehicles, fruits, clothes, instruments, furniture. 

```{r plot5, echo=FALSE, warning = FALSE, cache = TRUE}

plot5 <- data %>%
  filter(phase == 'test') %>%
  group_by(distribution, subid, target1) %>%
  summarise(correct = mean(correct_target1)) %>%
  gather(item, prop_correct, -distribution, -subid, -target1) %>%
  group_by(distribution, item, target1) %>%
  multi_boot_standard(col = "prop_correct")

ggplot(plot5,
       aes(x = target1, y=mean, fill=item)) +
  geom_bar(stat='identity') +
 # geom_linerange(aes(ymin = ci_lower, ymax = ci_upper)) +
  scale_fill_solarized()+
  guides(fill = F) +
  geom_hline(yintercept = 1/3, lty=2) +
  ylim(0, 1) +
  theme_few() +
  labs(x="category", y= "proportion chosen")
```

### Result by trial

We also want to look at whether participants change their choosing strategy across trials, for example, because they have picked up that the task is to choose the item from the most frequent category and thus perform better over time.

```{r plot6, echo=FALSE, warning = FALSE}
plot6 <- data %>%
  filter(phase == 'test') %>%
  group_by(distribution, trial, subid) %>%
  summarise(correct = mean(correct_target1)) %>%
  gather(item, prop_correct, -distribution, -trial, -subid) %>%
  group_by(distribution, item, trial) %>%
  multi_boot_standard(col = "prop_correct")

ggplot(plot6, 
       aes(x = trial, y = mean, col = item)) +
  geom_line(aes(group = item)) + 
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper), 
                  position = position_dodge(width = .1)) + 
  scale_colour_solarized(name = "Chosen item",
                       breaks = c("correct", "correct2", "correct3"),
                       labels = c("most frequent", "second most frequent", "least frequent"))+ 
  geom_hline(yintercept = 1/3, lty=2)+
  theme_few() +
  labs(x="trial", y= "proportion chosen")
```

We see that while the 4th trial has the best performance (most participants choosing the item from the most frequent category), there is a decline in performance in the 3rd trial.

# Moving forward
## Design decisions
* Four trials looks like a suitable length for the attention span of participants in the age group we are looking at.
* From the analysis of item category salience, we will remove the category of furniture and instruments, which do not seem to perform as well as the other 4 categories (mammals, vehicles, fruits, clothes).

## Data collection
* We pilot 10 more children with 4 categories and 4 trials with distribution (6-0-0). If the results go in the same direction as the previous results, we run a full sample of 2-, 3-, and 4-year-olds (20 children per age group). 
* If the results from the pilot suggest that children will not be able to do this, we change the procedure so that the agent is explicitly naming the target category (for example, asks for "car" 6 times instead of for different vehicles).
